<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>O.Y-FINMAG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Plotly für Charts -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* =======================
       GLOBALE VARIABLEN & RESET
       ======================= */
    :root {
      --bg: #0d0d0d;
      --fg: #f2f2f2;
      --card: #1a1a1a;
      --pos: #00ff88;
      --neg: #ff0055;
      --line: #00eaff;
      --font: 'Segoe UI', Arial, sans-serif;
      --gap: 12px;
      --modal-bg: rgba(0,0,0,0.8);
      --btn-bg: #00eaff;
      --btn-fg: #0d0d0d;
    }
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--fg);
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
    }
    h1, h2 { margin: 0; }
    button {
      cursor: pointer;
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 0.9rem;
    }
    select, input {
      background: var(--card);
      color: var(--fg);
      border: 1px solid #333;
      border-radius: 4px;
      padding: 4px 8px;
    }
    /* ================
       HEADER STYLES
       ================ */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--gap) calc(var(--gap)*2);
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
    }
    #header-left { display: flex; align-items: center; gap: var(--gap); }
    #markets { font-size: 0.9rem; }
    #header-right { display: flex; align-items: center; gap: var(--gap); }
    #clock, #current-price { font-weight: bold; font-size: 1rem; }
    /* =================
       MAIN LAYOUT
       ================= */
    main {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--gap);
      padding: var(--gap);
      overflow-y: auto;
    }
    /* Charts */
    .chart-container {
      position: relative;
      background: var(--card);
      border-radius: 8px;
      padding-top: 32px;
      height: 360px;
    }
    .chart-title {
      position: absolute;
      top: 8px;
      left: 16px;
      font-size: 1rem;
      font-weight: bold;
    }
    /* News */
    #news {
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }
    .news-item {
      display: grid;
      grid-template-columns: 80px 1fr;
      background: var(--card);
      border-radius: 6px;
      overflow: hidden;
      transition: transform .2s;
    }
    .news-item:hover {
      transform: translateY(-2px);
    }
    .news-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      background: #333;
    }
    .news-content {
      padding: 8px;
      display: flex;
      flex-direction: column;
    }
    .news-title {
      font-size: 0.95rem;
      line-height: 1.2;
    }
    .news-meta {
      margin-top: auto;
      font-size: 0.75rem;
      color: #888;
      display: flex;
      justify-content: space-between;
    }
    /* =================
       FOOTER (TICKER)
       ================= */
    footer {
      padding: var(--gap) calc(var(--gap)*2);
      border-top: 1px solid #333;
      display: flex;
      gap: var(--gap);
      overflow-x: auto;
      background: var(--bg);
    }
    .ticker-item {
      padding: 4px 8px;
      background: var(--card);
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.85rem;
    }
    /* =================
       MODAL STYLES
       ================= */
    .modal-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: var(--modal-bg);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: var(--card);
      border-radius: 8px;
      padding: var(--gap);
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }
    .modal h2 {
      margin-top: 0;
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      color: var(--fg);
      font-size: 1.2rem;
    }
    /* =================
       RESPONSIVE
       ================= */
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
      .chart-container { height: 280px; }
    }
  </style>
</head>
<body>

  <!-- =================
       HEADER
       ================= -->
  <header>
    <div id="header-left">
      <h1>❄️ Eismachine Ultimate</h1>
      <div id="markets">…</div>
    </div>
    <div id="header-right">
      <label>
        Symbol:
        <select id="symbol-select"></select>
      </label>
      <div id="current-price">–</div>
      <label>
        Währung:
        <select id="currency-select">
          <option>EUR</option>
          <option>USD</option>
          <option>INR</option>
          <option>GBP</option>
          <option>JPY</option>
        </select>
      </label>
      <div id="clock">--:--:--</div>
    </div>
  </header>

  <!-- =================
       MAIN CONTENT
       ================= -->
  <main>
    <!-- Chart-Bereich -->
    <section id="charts">
      <div class="chart-container" id="chart-main">
        <div class="chart-title" id="chart-title">Wähle ein Symbol</div>
      </div>
    </section>

    <!-- News-Feed -->
    <aside id="news">
      <h2>Live News</h2>
      <!-- JS füllt hier .news-item -->
    </aside>
  </main>

  <!-- =================
       FOOTER TICKER
       ================= -->
  <footer id="ticker">
    <!-- JS füllt hier .ticker-item -->
  </footer>

  <!-- =================
       MODALS
       ================= -->
  <!-- Chart Modal (Größere Ansicht) -->
  <div class="modal-overlay" id="modal-chart">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('modal-chart')">&times;</button>
      <h2 id="modal-chart-title">Chart</h2>
      <div id="modal-chart-content" style="height:500px;"></div>
    </div>
  </div>

  <!-- Calculator Modal -->
  <div class="modal-overlay" id="modal-calc">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('modal-calc')">&times;</button>
      <h2>Taschenrechner</h2>
      <input type="text" id="calc-display" readonly style="width:100%; font-size:1.2rem; margin-bottom:8px; padding:4px;">
      <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:4px;">
        <!-- Buttons 0-9, + - * /, =, C -->
        <button onclick="calcInput('7')">7</button>
        <button onclick="calcInput('8')">8</button>
        <button onclick="calcInput('9')">9</button>
        <button onclick="calcInput('/')">÷</button>

        <button onclick="calcInput('4')">4</button>
        <button onclick="calcInput('5')">5</button>
        <button onclick="calcInput('6')">6</button>
        <button onclick="calcInput('*')">×</button>

        <button onclick="calcInput('1')">1</button>
        <button onclick="calcInput('2')">2</button>
        <button onclick="calcInput('3')">3</button>
        <button onclick="calcInput('-')">−</button>

        <button onclick="calcInput('0')">0</button>
        <button onclick="calcInput('.')">.</button>
        <button onclick="calcEval()">=</button>
        <button onclick="calcClear()">C</button>
      </div>
    </div>
  </div>

  <!-- Currency Converter Modal -->
  <div class="modal-overlay" id="modal-conv">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('modal-conv')">&times;</button>
      <h2>Währungsrechner</h2>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input type="number" id="conv-amount" placeholder="Betrag" style="flex:1;">
        <select id="conv-from">
          <option>EUR</option><option>USD</option><option>INR</option><option>GBP</option><option>JPY</option>
        </select>
        <select id="conv-to">
          <option>EUR</option><option>USD</option><option>INR</option><option>GBP</option><option>JPY</option>
        </select>
      </div>
      <button onclick="doConvert()">Umrechnen</button>
      <div id="conv-result" style="margin-top:8px; font-weight:bold;"></div>
    </div>
  </div>

  <!-- =================
       JAVASCRIPT
       ================= -->
  <script>
  // ----------------------------------------------------
  // 1) BASIS-DATEN & API KEYS
  // ----------------------------------------------------
  const STOCKS = ['AAPL','MSFT','AMZN','NVDA','META','TSLA','V','JPM','BABA','ASML'];
  const CRYPTOS = ['BTCUSDT','ETHUSDT','BNBUSDT','USDCUSDT','XRPUSDT','SOLUSDT','LTCUSDT','MATICUSDT','SHIBUSDT'];
  const ALL = [...STOCKS, ...CRYPTOS];

  const NEWS_API_KEY = 'DEIN_NEWSAPI_KEY';
  const FINNHUB_KEY    = 'DEIN_FINNHUB_KEY';
  const EXCHANGE_KEY   = 'DEIN_EXCHANGE_RATE_API_KEY';

  let exchangeRates = { EUR:1 };

  // Utility CSS variable reader
  const varC = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

  // ----------------------------------------------------
  // 2) UTILITY: MODAL HANDLER
  // ----------------------------------------------------
  function openModal(id) {
    document.getElementById(id).classList.add('active');
  }
  function closeModal(id) {
    document.getElementById(id).classList.remove('active');
  }

  // ----------------------------------------------------
  // 3) UHR & MARKET SESSIONS
  // ----------------------------------------------------
  function updateClock() {
    document.getElementById('clock').innerText =
      new Date().toLocaleTimeString('de-DE',{hour12:false});
  }
  setInterval(updateClock,1000);
  updateClock();

  const sessions = [
    { name:'Europa', open:9,   close:17.5 },
    { name:'USA',    open:15.5, close:22   },
    { name:'Asien',  open:2,    close:8    }
  ];
  function updateMarkets() {
    const now = new Date();
    // convert to CET hours decimal
    const CET = now.getUTCHours() + now.getTimezoneOffset()/60 + 1;
    document.getElementById('markets').innerText =
      sessions.map(s =>
        (CET >= s.open && CET < s.close ? '🟢' : '🔴') + s.name
      ).join(' ');
  }
  setInterval(updateMarkets,60000);
  updateMarkets();

  // ----------------------------------------------------
  // 4) LOAD EXCHANGE RATES
  // ----------------------------------------------------
  async function loadExchange() {
    try {
      const res = await fetch(`https://v6.exchangerate-api.com/v6/${EXCHANGE_KEY}/latest/EUR`);
      const json = await res.json();
      exchangeRates = json.conversion_rates;
    } catch(e) {
      console.error('Exchange load error', e);
    }
  }
  loadExchange();

  function convert(v) {
    const cur = document.getElementById('currency-select').value;
    return (v * (exchangeRates[cur]||1)).toFixed(2) + ' ' + cur;
  }

  document.getElementById('currency-select')
    .addEventListener('change', () => {
      updateAllTickers();
      if (currentSymbol) renderChart(currentSymbol, true);
    });

  // ----------------------------------------------------
  // 5) TICKER-SETUP (Stocks & Crypto)
  // ----------------------------------------------------
  const tickerEl = document.getElementById('ticker');
  function ensureTicker(sym) {
    if (!document.getElementById('tick-'+sym)) {
      const sp = document.createElement('span');
      sp.id = 'tick-'+sym;
      sp.className = 'ticker-item';
      tickerEl.append(sp);
    }
  }

  // --- Stocks via Finnhub ---
  const wsStocks = new WebSocket(`wss://ws.finnhub.io?token=${FINNHUB_KEY}`);
  wsStocks.onopen = () => {
    STOCKS.forEach(s => wsStocks.send(JSON.stringify({ type:'subscribe', symbol:'O:'+s })));
  };
  wsStocks.onmessage = e => {
    const msg = JSON.parse(e.data);
    msg.data?.forEach(u => {
      const sym = u.s.replace('O:','');
      ensureTicker(sym);
      const price = u.p;
      const text = `${sym}: ${convert(price)}`;
      const el = document.getElementById('tick-'+sym);
      el.innerText = text;
      el.dataset.raw = price;
    });
  };

  // --- Crypto via Binance ---
  const wsCrypto = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');
  wsCrypto.onmessage = e => {
    JSON.parse(e.data).forEach(u => {
      if (CRYPTOS.includes(u.s)) {
        ensureTicker(u.s);
        const price = parseFloat(u.c);
        const text = `${u.s}: ${convert(price)}`;
        const el = document.getElementById('tick-'+u.s);
        el.innerText = text;
        el.dataset.raw = price;
      }
    });
  };

  function updateAllTickers() {
    ALL.forEach(sym => {
      const el = document.getElementById('tick-'+sym);
      if (el && el.dataset.raw) {
        el.innerText = `${sym}: ${convert(parseFloat(el.dataset.raw))}`;
      }
    });
  }

  // ----------------------------------------------------
  // 6) SYMBOL-SELECTOR
  // ----------------------------------------------------
  const sel = document.getElementById('symbol-select');
  ALL.forEach(s => sel.add(new Option(s,s)));
  let currentSymbol = null;
  sel.addEventListener('change', () => {
    const sym = sel.value;
    currentSymbol = sym;
    document.getElementById('current-price').innerText =
      document.getElementById('tick-'+sym)?.innerText || '–';
    renderChart(sym, false);
  });

  // ----------------------------------------------------
  // 7) CHART-RENDERING
  // ----------------------------------------------------
  const chartDiv     = document.getElementById('chart-main');
  const chartTitle   = document.getElementById('chart-title');
  let wsChart        = null;
  let modalWsChart   = null;

  function clearOldChart(ws) {
    if (ws) ws.close();
    Plotly.purge(chartDiv);
  }

  async function renderChart(sym, isUpdate) {
    // wenn Refresh durch Währungswechsel
    if (!isUpdate) clearOldChart(wsChart);
    chartTitle.innerText = sym;
    // Unsubscribe modal too
    if (modalWsChart) modalWsChart.close();

    // Chart-Parameter
    const isCrypto = CRYPTOS.includes(sym);
    const dataTrace = isCrypto
      ? { x:[], open:[], high:[], low:[], close:[], type:'candlestick',
          increasing:{line:{color:varC('--pos')}}, decreasing:{line:{color:varC('--neg')}} }
      : { x:[], y:[], mode:'lines', line:{color:varC('--line')} };

    Plotly.newPlot(chartDiv,[dataTrace], {
      plot_bgcolor:varC('--bg'), paper_bgcolor:varC('--bg'),
      xaxis:{ gridcolor:'#333', color:varC('--fg') },
      yaxis:{ gridcolor:'#333', color:varC('--fg') }
    }, {responsive:true});

    // WS für Hauptchart
    if (isCrypto) {
      wsChart = new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_1m`);
      wsChart.onmessage = e => {
        const k = JSON.parse(e.data).k;
        const t = new Date(k.t);
        const factor = exchangeRates[document.getElementById('currency-select').value] || 1;
        Plotly.extendTraces(chartDiv, {
          x:[[t]],
          open:[[k.o*factor]], high:[[k.h*factor]], low:[[k.l*factor]], close:[[k.c*factor]]
        },[0]);
      };
    } else {
      wsChart = new WebSocket(`wss://ws.finnhub.io?token=${FINNHUB_KEY}`);
      wsChart.onopen = () => wsChart.send(JSON.stringify({ type:'subscribe', symbol:'O:'+sym }));
      wsChart.onmessage = e => {
        const msg = JSON.parse(e.data);
        msg.data?.forEach(u => {
          const t = new Date(u.t);
          const val = u.p * (exchangeRates[document.getElementById('currency-select').value]||1);
          Plotly.extendTraces(chartDiv, { x:[[t]], y:[[val]] }, [0]);
        });
      };
    }

    // Klick öffnet Modal mit großem Chart
    chartDiv.onclick = () => openModalChart(sym, isCrypto);
  }

  // ----------------------------------------------------
  // 8) MODAL-CHART (GROSSANSICHT)
  // ----------------------------------------------------
  function openModalChart(sym, isCrypto) {
    const title = document.getElementById('modal-chart-title');
    const content = document.getElementById('modal-chart-content');
    title.innerText = `Großansicht: ${sym}`;
    content.innerHTML = '<div id="modal-plot" style="width:100%;height:100%;"></div>';
    openModal('modal-chart');

    // Erzeuge Plotly im Modal
    const trace = isCrypto
      ? { x:[], open:[], high:[], low:[], close:[], type:'candlestick',
          increasing:{line:{color:varC('--pos')}}, decreasing:{line:{color:varC('--neg')}} }
      : { x:[], y:[], mode:'lines', line:{color:varC('--line')} };

    Plotly.newPlot('modal-plot', [trace], {
      plot_bgcolor:varC('--bg'), paper_bgcolor:varC('--bg'),
      xaxis:{gridcolor:'#333',color:varC('--fg')},
      yaxis:{gridcolor:'#333',color:varC('--fg')}
    }, {responsive:true});

    // Websocket für Modal
    if (isCrypto) {
      modalWsChart = new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_1m`);
      modalWsChart.onmessage = e => {
        const k = JSON.parse(e.data).k;
        const t = new Date(k.t);
        const factor = exchangeRates[document.getElementById('currency-select').value]||1;
        Plotly.extendTraces('modal-plot', {
          x:[[t]],
          open:[[k.o*factor]], high:[[k.h*factor]], low:[[k.l*factor]], close:[[k.c*factor]]
        }, [0]);
      };
    } else {
      modalWsChart = new WebSocket(`wss://ws.finnhub.io?token=${FINNHUB_KEY}`);
      modalWsChart.onopen = () => modalWsChart.send(JSON.stringify({ type:'subscribe', symbol:'O:'+sym }));
      modalWsChart.onmessage = e => {
        const msg = JSON.parse(e.data);
        msg.data?.forEach(u => {
          const t = new Date(u.t);
          const val = u.p * (exchangeRates[document.getElementById('currency-select').value]||1);
          Plotly.extendTraces('modal-plot', { x:[[t]], y:[[val]] }, [0]);
        });
      };
    }
  }

  // ----------------------------------------------------
  // 9) LIVE NEWS
  // ----------------------------------------------------
  async function loadNews() {
    try {
      const res = await fetch(
        `https://newsapi.org/v2/top-headlines?category=business&language=en&pageSize=5&apiKey=${NEWS_API_KEY}`
      );
      const json = await res.json();
      const container = document.getElementById('news');
      // alte News entfernen
      container.querySelectorAll('.news-item').forEach(n => n.remove());
      // neue Artikel
      json.articles.forEach(a => {
        const div = document.createElement('div');
        div.className = 'news-item';
        const img = a.urlToImage
          ? `<img class="news-thumb" src="${a.urlToImage}" alt="">`
          : `<div class="news-thumb"></div>`;
        div.innerHTML = `
          ${img}
          <div class="news-content">
            <p class="news-title">${a.title}</p>
            <div class="news-meta">
              <span>${a.source.name}</span>
              <span>${new Date(a.publishedAt).toLocaleTimeString('de-DE',{hour12:false})}</span>
            </div>
            <a href="${a.url}" target="_blank" style="font-size:0.75rem; color:var(--line)">→ Mehr</a>
          </div>`;
        container.append(div);
      });
    } catch(e) {
      console.error('News error', e);
    }
  }
  loadNews();
  setInterval(loadNews, 300_000);

  // ----------------------------------------------------
  // 10) TASCHENRECHNER
  // ----------------------------------------------------
  function calcInput(v) {
    const d = document.getElementById('calc-display');
    d.value += v;
  }
  function calcClear() {
    document.getElementById('calc-display').value = '';
  }
  function calcEval() {
    const d = document.getElementById('calc-display');
    try {
      // eslint-disable-next-line no-eval
      d.value = eval(d.value);
    } catch {
      d.value = 'Error';
    }
  }

  // ----------------------------------------------------
  // 11) WÄHRUNGSRECHNER
  // ----------------------------------------------------
  function doConvert() {
    const amt  = parseFloat(document.getElementById('conv-amount').value) || 0;
    const from = document.getElementById('conv-from').value;
    const to   = document.getElementById('conv-to').value;
    const rate = (exchangeRates[to]||1) / (exchangeRates[from]||1);
    const res  = (amt * rate).toFixed(4);
    document.getElementById('conv-result').innerText = `${res} ${to}`;
  }

  // ----------------------------------------------------
  // INITIALISIERUNG
  // ----------------------------------------------------
  // setze Default-Symbol
  sel.value = ALL[0];
  sel.dispatchEvent(new Event('change'));
  </script>
</body>
</html>
